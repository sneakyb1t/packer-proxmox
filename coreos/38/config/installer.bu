variant: fcos
version: 1.5.0
storage:
  files:
    - path: /usr/local/bin/install_qemu_agent.sh
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          git clone https://git.qemu.org/git/qemu.git
          cd qemu
          ./configure --enable-guest-agent
          make
          sudo make install
passwd:
  users:
    - name: packer
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCZ391jiPNiscavMEeKK08roPB0UhReEhRRicpqI0cy88H4OHHUOPhHdiOZO7tIBHDS2ZBorjZBxNbZg8DLT+dwrW41qbnHrOhcLb7MoAlHosghA6wuMNKshSRzE37jD5le7gqOHreL24TFjV/s6sFanDdvaMoGa3CQd+e6Q8Vq3Y6XZjDylAj35ZD4PBUb+MIUiKReOJ0E0CqT0hoWocdddlCxrJCZweydSkG7oJ44MHvwRIYrHQj4fEJANMKwtEFz4U745e96pZ63vEqK4uZgIbOrcXtSDxMy7W5HNPKpKpdddXwGeyPTecwP2+8iXLWbQ+ITU1dqtGHXHwI7FNLHiYUzIOZ8XCax6SvDqrhg06itgfncwf1eiXo/bPRF9zo5GladjoHQZ0Hsvt//yjSz/lECoQ4b5JjQUkDfPl+qRCNm/WTgvSqfZltb+w96ntS3a+PjGWI59wJcAXC2svs5Bm7gFXlz1YBNdgiWVKqhiO76epaIiGh4MD2FzWfbiHs=
      groups:
        - wheel
        - sudo
systemd:
  units:
    - name: install-qemu-guest-agent.service
      enabled: true
      contents: |
        [Unit]
        Description=Install QEMU guest agent
        After=network-online.target
        ConditionFirstBoot=true

        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/install_qemu_agent.sh
        RemainAfterExit=yes

        [Install]
        WantedBy=multi-user.target

    - name: qemu-guest-agent.service
      enabled: true
      contents: |
        [Unit]
        Description=Runs QEMU guest agent
        After=network-online.target

        [Service]
        ExecStart=/usr/local/bin/qemu-ga
        Restart=always
        RestartSec=3
        StartLimitIntervalSec=0

        [Install]
        WantedBy=multi-user.target

