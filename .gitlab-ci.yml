image:
  name: hashicorp/packer:1.8
  entrypoint:
    - '/usr/bin/env'
    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

variables:
  vars_file: "/home/gitlab-runner/data/secrets/packer-proxmox-vars.sh"

before_script:
  - packer --version

stages:
  - prerequisites
  - validate
  - build

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: $RUNNER != null
      variables:
        RUNNER_TAG: $RUNNER
    - if: $GITLAB_USER_ID == "120697"
      variables:
        RUNNER_TAG: "vle-home-shell"
    - if: $GITLAB_USER_ID == "3975485"
      variables:
        RUNNER_TAG: "vle-home-shell"

load_vars:
  stage: prerequisites
  tags: [$RUNNER_TAG]
  script:
    - |
      echo "Load vars file if present"
      [ -e $vars_file ] && set -a && . $vars_file || echo "no var file found"
      echo "Generate coreos config files"
      envsubst < "coreos/38/config/installer.bu.example" > "coreos/38/config/installer.bu"
      envsubst < "coreos/38/config/template.bu.example"  > "coreos/38/config/template.bu"
      butane --pretty --strict coreos/38/config/installer.bu > coreos/38/config/installer.ign
      butane --pretty --strict coreos/38/config/template.bu > coreos/38/config/template.ign
      echo "Generate common vars file"
      envsubst < "common.pkrvars.hcl.example" > "common-ci.pkrvars.hcl"
  artifacts:
    untracked: true
    paths:
      - common-ci.pkrvars.hcl
      - coreos/38/config/template.ign
      - coreos/38/config/installer.ign

validate:
  stage: validate
  tags:
  - $RUNNER_TAG
  script:
    - find -maxdepth 2 -type d -wholename "./*/*" -not -path "./.git/*" |
      xargs -I {} bash -c "echo 'Validating {}' && packer validate -var-file=common-ci.pkrvars.hcl {}"
  needs:
    - job: load_vars

build:
  stage: build
  tags: [$RUNNER_TAG]
  script:
    - |
      export MODIFIED_FILES="$(git diff --name-only ${CI_COMMIT_BEFORE_SHA} ${CI_COMMIT_SHA})"
      echo "${MODIFIED_FILES}"
      for folder in $(find . -type d -name '[0-9]*' -not -path "./.git/*"); do
        if [[ "$MODIFIED_FILES" =~ (^.*${folder/.\//}.*$) ]]; then
        echo "Change detected in $folder, building"
        packer build -var-file=common-ci.pkrvars.hcl $folder
        else
        echo "No changes in $folder. Skipping build."
        fi
      done
  needs:
    - job: load_vars

build_all:
  stage: build
  tags: [$RUNNER_TAG]
  script:
    - |
      for folder in $(find . -type d -name '[0-9]*' -not -path "./.git/*"); do
        packer build -var-file=common-ci.pkrvars.hcl $folder
      done
  needs:
    - job: load_vars
  when: manual

