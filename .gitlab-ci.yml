stages:
  - validate
  - prerequis
  - build
  - build_all

validate:
  stage: validate
  tags: [sasal-home]
  script:
    - |
      for folder in $(find . -type d -name '[0-9]*'); do
        if [[ -d $folder ]]; then
          # Extract distro and version from folder
          IFS='/' read -ra FOLDER <<< "$folder"
          OS=${FOLDER[1]}
          VERSION=${FOLDER[2]}
          if [ -n "$CI_COMMIT_MODIFIED_FILES" ] && [[ "$CI_COMMIT_MODIFIED_FILES" =~ "$folder/" || "$CI_COMMIT_MODIFIED_FILES" =~ "common.pkrvars.hcl.example" ]]; then
            # Validate Packer configuration for the modified distro/version or common.hcl file
            ls -alrth "$folder"
            packer validate -var-file=common-ci.pkrvars.hcl "$folder"
          else
            echo "No changes in $folder or common.pkrvars.hcl.example Skipping validation."
          fi
        fi
      done

prerequis:
  stage: prerequis
  tags: [sasal-home]
  script:
    - |
      #create necessary coreos config
      envsubst < "coreos/38/config/installer.bu.example" > "coreos/38/config/installer.bu"
      envsubst < "coreos/38/config/template.bu.example"  > "coreos/38/config/template.bu"
      butane --pretty --strict coreos/38/config/installer.bu > coreos/38/config/installer.ign
      butane --pretty --strict coreos/38/config/template.bu > coreos/38/config/template.ign
      if [ -f "common.pkrvars.hcl.example" ]; then
        envsubst < "common.pkrvars.hcl.example" > "common-ci.pkrvars.hcl"
        echo "Generated common-ci.pkrvars.hcl from common.pkrvars.hcl.example"
      else
        echo "common.pkrvars.hcl.example file not found"
      fi
  artifacts:
    untracked: true
    paths:
      - common-ci.pkrvars.hcl
      - coreos/38/config/template.ign
      - coreos/38/config/installer.ign

build:
  stage: build
  script:
    - |
      for folder in $(find . -type d -name '[0-9]*'); do
        if [[ -d $folder ]]; then
          dir=$(basename "$folder")
          # Extract distro and version from folder
          IFS='/' read -ra FOLDER <<< "$dir"
          OS=${FOLDER[0]}
          VERSION=${FOLDER[1]}
          if [[ -n "$CI_COMMIT_MODIFIED_FILES" && "$CI_COMMIT_MODIFIED_FILES" =~ (^| )"$dir"(/|$) ]]; then
            # Build the machine using Packer for the modified distro/version
            packer build -var-file=common-ci.pkrvars.hcl "$folder"
          else
            echo "No changes in $dir. Skipping build."
          fi
        fi
      done
  needs:
    - job: prerequis


build_all:
  stage: build_all
  tags: [sasal-home]
  script:
    - |
      for folder in $(find . -type d -name '[0-9]*'); do
        dir=$(basename "$folder")
        # Extract distro and version from folder
        IFS='/' read -ra FOLDER <<< "$dir"
        OS=${FOLDER[0]}
        VERSION=${FOLDER[1]}
        packer build -var-file=common-ci.pkrvars.hcl "$folder"
      done
  needs:
    - job: prerequis
