image:
  name: hashicorp/packer:1.8
  entrypoint:
    - '/usr/bin/env'
    - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

variables:
  vars_file: "/home/gitlab-runner/data/secrets/packer-proxmox-vars.sh"

before_script:
  - packer --version
  - packer init require.pkr.hcl

stages:
  - prerequisites
  - validate
  - build

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH || $CI_COMMIT_TAG || $CI_OPEN_MERGE_REQUESTS'
    - if: $GITLAB_USER_ID == "120697"
      variables:
        RUNNER_TAG: "vle-home-shell"
    - if: $GITLAB_USER_ID == "3975485"
      variables:
        RUNNER_TAG: "vle-home-shell"

load_vars:
  stage: prerequisites
  tags: [$RUNNER_TAG]
  script:
    - |
      echo "Load vars file if present"
      [ -e $vars_file ] && set -a && . $vars_file || echo "no var file found"
      echo "Generate common vars file"
      envsubst < "common.pkrvars.hcl.example" > "common-ci.pkrvars.hcl"
  artifacts:
    untracked: true
    paths:
      - common-ci.pkrvars.hcl

validate:
  stage: validate
  tags:
  - $RUNNER_TAG
  script:
    - find . -maxdepth 2 -mindepth 2 -type d \( -not -path "./.git/*" -and -not -path "./roles/*" \)  |
      xargs -I {} bash -c "echo 'Validating {}' && packer validate -no-warn-undeclared-var -only=proxmox-iso* -var-file=common-ci.pkrvars.hcl {}"
  needs:
    - job: load_vars

build:
  stage: build
  tags: [$RUNNER_TAG]
  script:
    - |
      echo "${CI_COMMIT_REF_NAME}"
      echo "${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}"
      export MODIFIED_FILES="$(git diff --name-only origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME})"
      echo "${MODIFIED_FILES}"
      for folder in $(find . -maxdepth 2 -mindepth 2 -type d \( -not -path "./.git/*" -and -not -path "./roles/*" \)); do
        if [[ "$MODIFIED_FILES" =~ (^.*${folder/.\//}.*$) ]]; then
        echo "Change detected in $folder, building"
        packer build -force -var-file=common-ci.pkrvars.hcl $folder
        else
        echo "No changes in $folder. Skipping build."
        fi
      done
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_OPEN_MERGE_REQUESTS'
  needs:
    - job: load_vars

build_all:
  stage: build
  tags: [$RUNNER_TAG]
  script:
    - |
      for folder in $(find . -type d -name '[0-9]*' \( -not -path "./.git/*" -and -not -path "./roles/*" \)); do
        packer build -var-file=common-ci.pkrvars.hcl $folder
      done
  needs:
    - job: load_vars
  when: manual

